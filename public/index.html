<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>éº»é›€å¾…ã¡ç‰Œãƒ†ã‚¹ãƒˆ</title>
<style>
  body {
    text-align: center;
    font-family: sans-serif;
    background-color: #f8f9fa;
  }

  h1 {
    margin-bottom: 20px;
  }

  #question-image {
    width: 1100px;
    max-width: 95%;
    height: auto;
    margin-bottom: 20px;
  }

  .choice-row {
    display: flex;
    justify-content: center;
    margin-bottom: 10px;
    flex-wrap: wrap;
  }

  .choice-row img {
    margin: 2px;
    width: 100px;
    height: 120px;
    cursor: pointer;
    border: 2px solid transparent;
    border-radius: 5px;
    transition: all 0.2s;
  }

  .choice-row img.selected {
    border-color: #007bff;
    box-shadow: 0 0 6px #007bff;
  }

  button {
    margin-top: 15px;
    padding: 10px 20px;
    font-size: 18px;
    cursor: pointer;
    border: none;
    border-radius: 6px;
    background-color: #007bff;
    color: white;
    transition: 0.2s;
  }

  button:hover {
    background-color: #0056b3;
  }

  #result {
    font-size: 22px;
    margin-top: 20px;
    font-weight: bold;
  }
</style>
</head>
<body>

<h1>éº»é›€å¾…ã¡ç‰Œãƒ†ã‚¹ãƒˆ</h1>

<img src="images/q1.png" alt="å•é¡Œã®æ‰‹ç‰Œ" id="question-image">

<div id="choices-container"></div>

<button id="submit-btn" onclick="submitAnswer()" style="display:none;">é€ä¿¡</button>
<button id="next-btn" onclick="nextQuestion()">æ¬¡ã®å•é¡Œ</button>

<p id="result"></p>

<script>
  const totalChoices = 34; // å…¨34ç¨®é¡ã®ç‰Œç”»åƒã‚’ä½¿ç”¨

  // å„å•é¡Œãƒ‡ãƒ¼ã‚¿
  const questions = [
    { img:'images/q1.png', correct:['a11','a12','a13'] },
    { img:'images/q2.png', correct:['a17','a19','a22'] },
    { img:'images/q3.png', correct:['a1','a4','a7','a8'] },
    { img:'images/q4.png', correct:['a3','a4','a5','a6','a7'] }
    // ã“ã“ã«q5ã€œq20ã¾ã§è¿½åŠ ã§ãã‚‹
  ];

  let currentQuestion = 0;
  let selectedChoices = [];

  const container = document.getElementById('choices-container');
  const submitBtn = document.getElementById('submit-btn');
  const nextBtn = document.getElementById('next-btn');
  const resultEl = document.getElementById('result');

  // é¸æŠè‚¢ç”»åƒã®é…ç½®
  function loadChoices() {
    const rows = [9,9,9,7];
    let count = 1;
    rows.forEach(rowCount => {
      const rowDiv = document.createElement('div');
      rowDiv.className = 'choice-row';
      for(let i=0; i<rowCount; i++) {
        if(count > totalChoices) break;
        const img = document.createElement('img');
        img.src = `images/a${count}.png`;
        img.id = `a${count}`;
        img.onclick = () => toggleSelect(img.id);
        rowDiv.appendChild(img);
        count++;
      }
      container.appendChild(rowDiv);
    });
  }

  // ç‰Œé¸æŠã®ON/OFF
  function toggleSelect(id) {
    const index = selectedChoices.indexOf(id);
    const imgEl = document.getElementById(id);
    if(index === -1) {
      selectedChoices.push(id);
      imgEl.classList.add('selected');
    } else {
      selectedChoices.splice(index,1);
      imgEl.classList.remove('selected');
    }
  }

  // å›ç­”é€ä¿¡å‡¦ç†
  function submitAnswer() {
    const correctSet = new Set(questions[currentQuestion].correct);
    const selectedSet = new Set(selectedChoices);
    let allCorrect = true;

    correctSet.forEach(ans => { if(!selectedSet.has(ans)) allCorrect = false; });
    selectedSet.forEach(sel => { if(!correctSet.has(sel)) allCorrect = false; });

    if(allCorrect) {
      resultEl.textContent = 'æ­£è§£ï¼ğŸ‰';
      resultEl.style.color = 'green';
    } else {
      resultEl.textContent = 'ä¸æ­£è§£â€¦';
      resultEl.style.color = 'red';
    }

    // çµæœã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
    sendResultToServer(allCorrect);
  }

  // ã‚µãƒ¼ãƒãƒ¼ã«JSONé€ä¿¡
  function sendResultToServer(isCorrect) {
    const payload = {
      question: currentQuestion + 1,
      selected: selectedChoices,
      correct: questions[currentQuestion].correct,
      result: isCorrect ? 'æ­£è§£' : 'ä¸æ­£è§£',
      timestamp: new Date().toISOString()
    };

    fetch('/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => console.log('çµæœé€ä¿¡æˆåŠŸ:', data))
    .catch(err => console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', err));
  }

  // æ¬¡ã®å•é¡Œã¸
  function nextQuestion() {
    if(currentQuestion < questions.length - 1) {
      currentQuestion++;
      selectedChoices = [];
      resultEl.textContent = '';
      document.getElementById('question-image').src = questions[currentQuestion].img;

      for(let i=1; i<=totalChoices; i++) {
        document.getElementById(`a${i}`).classList.remove('selected');
      }

      if(currentQuestion === questions.length - 1){
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'inline-block';
      } else {
        nextBtn.style.display = 'inline-block';
        submitBtn.style.display = 'none';
      }
    }
  }

  loadChoices();
  
  // åˆ¶é™æ™‚é–“è¨­å®šï¼ˆä¾‹ï¼š60ç§’ï¼‰
let remainingTime = 60;
const timerDisplay = document.createElement('p');
timerDisplay.id = 'timer';
timerDisplay.style.fontSize = '20px';
timerDisplay.style.fontWeight = 'bold';
document.body.insertBefore(timerDisplay, document.getElementById('question-image'));

// ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹
const timerId = setInterval(() => {
  timerDisplay.textContent = `æ®‹ã‚Šæ™‚é–“: ${remainingTime} ç§’`;
  remainingTime--;
  if (remainingTime < 0) {
    clearInterval(timerId);
    alert('æ™‚é–“åˆ‡ã‚Œã§ã™ã€‚è‡ªå‹•ã§é€ä¿¡ã—ã¾ã™ã€‚');
    submitAnswer();
  }
}, 1000);

</script>

</body>
</html>
